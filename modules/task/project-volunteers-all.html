<section>
    VmInclude:__COMPONENT__/grid/grid.v3.html
</section>
<script>
    function F__ID(){
        //-------------------------------------
        VmInclude:__COMPONENT__/grid/grid.v3.js
        //-------------------------------------
        _fields="_Form,Project,_Call_Log,_Summary,Volunteer,Login_Email,Status,Reserved,Start_date,End_date,Volunteering|I2_Medical_Research,Gender|I2_Gender,YOB|I2_Year_of_Birth,Asthma|I2_Asthma,COPD|I2_COPD,Emphysema|I2_Emphysema,Lung_Cancer|I2_Lung_Cancer";
        _fields+=",Rhintis|I2_Rhintis,Insomnia|I2_Insomnia,Narcolepsy|I2_Narcolepsy,OSA|I2_OSA,RLS|I2_RLS,Phone|I2_Phone";
        _fields+=",Submit Date|DateTime";
		//-------------------------------------
		var prefix=$vm.module_list[$vm.vm['__ID'].name].prefix;
		var volunteer_tid=$vm.module_list[prefix+'volunteer'].table_id;
        //-------------------------------------
        $('#new__ID').hide();
        //-------------------------------------
        _cell_render=function(records,I,field,td,set_value,source){
            switch(field){
                case 'Volunteer':
                case 'Login_Email':
                case 'Project':
                case 'I2_Medical_Research':
                case 'I2_Gender':
                case 'I2_Year_of_Birth':
                case 'I2_Asthma':
                case 'I2_COPD':
                case 'I2_Emphysema':
                case 'I2_Lung_Cancer':
                case 'I2_Rhintis':
                case 'I2_Insomnia':
                case 'I2_Narcolepsy':
                case 'I2_OSA':
                case 'I2_RLS':
                case 'I2_Phone':
                case 'I2_Email':
                if(records[I].Reserved=='Reserved'){
                    td.css('color','red');
                    td.attr('contenteditable','false')
                    td.find('div').attr('contenteditable','false')
                }
                else {records[I].vm_readonly[field]=true;}
                break;
                case '_Call_Log':
                    records[I].vm_custom[field]=true;
                    if(records[I].UID==null || records[I].UID==undefined) return;
                    td.html("<u style='cursor:pointer;'>Call Log...</u>");
                    td.find('u').on('click',function(){
						$vm.nav_load_module(prefix+'call-log-child','',{record:records[I]});
	                })
                    break;
                case '_Summary':
                        records[I].vm_custom[field]=true;
                        if(records[I].UID==null || records[I].UID==undefined) return;
                        td.html("<u style='cursor:pointer;'>Summary...</u>");
						td.find('u').on('click',function(){
							$vm.nav_load_module(prefix+'summary','',{record:records[I]});
		                })
                        break;
                case 'Status':
                            records[I].vm_custom[field]=true;
                            var html="<select style='border:0;'>"
                            if(records[I].Reserved=='Reserved'){
                                html+="<option>Registration</option>";
                                html+="<option>Screening Failure</option>";
                                html+="</select>"
                            }
                            else{
                                html+="<option>Registration</option>";
                                html+="<option>Screening</option>";
                                html+="<option>Screening Failure</option>";
                                html+="<option>Enrolled</option>";
                                html+="<option>Withdrawn</option>";
                                html+="<option>Completed</option>";
                                html+="</select>"
                            }
                            td.html(html)
                            td.find('select').val(records[I][field])
                            td.find('select').on('change', function(){
                                set_value($(this).val(),records,I,field);
                                var today = new Date();
                                var dd = today.getDate();
                                var mm = today.getMonth()+1; //January is 0!
                                var yyyy = today.getFullYear();
                                if(dd<10){dd='0'+dd;}
                                if(mm<10){mm='0'+mm;}
                                var today = dd+'/'+mm+'/'+yyyy;
                                if($(this).val()==='DO NOT CALL' || $(this).val()==='Screening'){
                                    set_value(today,records,I,'Start_date');
                                    _render(I);
                                }
                                if($(this).val()==='Completed' || $(this).val()==='Withdrawn'){
                                    set_value(today,records,I,'End_date');
                                    _render(I);
                                }
                            });
                            break;
					case 'Reserved':
                        if(records[I].Reserved=='Reserved'){
                            td.css('color','red');
                        }
                        td.attr('contenteditable','false')
                        td.find('div').attr('contenteditable','false')
                        break;
                    case 'Start_date':
                    case 'End_date':
	                    if(records[I].Reserved=='Reserved'){
	                        td.css('color','red');
	                        td.attr('contenteditable','false')
	                        td.find('div').attr('contenteditable','false')
	                    }
	                    else{
	                        VmInclude:__COMPONENT__/grid/field_date.js
	                    }
                        break;
            }
        }
        //-------------------------------------
		var input;
        $('#D__ID').on('load',function(){
            //-----------------------
			input=$vm.vm['__ID'].op.input;
			$('#new__ID').hide();
            //$('#title__ID').text(input.record.Project_Name);
            _set_req(); _request_data();
        })
        //-------------------------------------
        var _set_req=_set_req_export=function(){
            var sql="with tb0 as (select busy=case when count(ID) > 0 then 'Reserved' end,EM=right(RTRIM(S2), len(S2)-16) from [TABLE-"+_db_pid+"] where (S3='Screening' or S3='Enrolled') and S1<>@s2 group by S2)"
            sql+=",tb as (select Information,LE=@('Login_Email'),ID,UID,PUID,DateTime,Author,busy,RowNum=row_number() over (order by ID DESC) from [TABLE-"+_db_pid+"-@S1] left join tb0 on EM=@('Login_Email') where S1=@s2 )";
            sql+=",tb1 as (select V_UID=UID,Information2=Information,S2 from [TABLE-20008533])";
            sql+="select V_UID,Information2,Information,ID,UID,PUID,DateTime,Author,Reserved=isnull(busy,''),RowNum from tb left join tb1 on S2=LE where RowNum between @I6 and @I7";
            var sql_n="select count(ID) from [TABLE-"+_db_pid+"-@S1] where  S1=@s2";
            _req={cmd:'query_records',db_pid:_db_pid,sql:sql,sql_n:sql_n,s1:'"'+$('#keyword__ID').val()+'"',I:$('#I__ID').text(),page_size:$('#page_size__ID').val(),s2:input.record.Project_Name}
        }
        //-------------------------------------
		/*
		var remove=[];
        var check_status=function(em,k){
            var sql="select Information,LE=@('Login_Email'),ID,UID,PUID,DateTime,Author from [TABLE-"+_db_pid+"-@S1] where @('Login_Email')=@s2 and (S3='Screening' or S3='Enrolled') and S1<>@s3 ";
            _req={cmd:'query_records',db_pid:_db_pid,sql:sql,s2:em,s3:$vm.vm['__ID'].op.project_name}
            $VmAPI.request({data:_req,callback:function(res){
                if(res.records.length>0){
                    remove[k]=true;
                }
                else remove[k]=false;
            }})
        }
		*/
        //-------------------------------------
        _before_submit=function(record,dbv){
            dbv.S3=record.Status;
            return true;
        };
        //-------------------------------------
    }
</script>
<style>
    VmInclude:__COMPONENT__/grid/grid.v3.css
</style>
