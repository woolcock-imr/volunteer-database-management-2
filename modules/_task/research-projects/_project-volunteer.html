<section>
    VmInclude:__COMPONENT__/grid/grid.v3.html
</section>
<script>
    function F__ID(){
        //-------------------------------------
        VmInclude:__COMPONENT__/grid/grid.v3.js
		_json='';
		//-------------------------------------
		_fields="_Form,ID,bID,bFlag,volunteer_UID|UID"; //gp,b,R_V1,P_V1,RP1,P_V2,RP2
		_fields+=",Status,_Call_Log,_Summary,Start_date,End_date";
		_fields+=",First_Name,Last_Name,Volunteering|Medical_Research,Gender,YOB,Asthma,COPD,Emphysema,Lung_Cancer";
        _fields+=",Rhintis,Insomnia,Narcolepsy,OSA,RLS,Phone";
		_fields+=",Submit Date|DateTime,_Delete";
		//-------------------------------------
		var prefix=$vm.module_list[$vm.vm['__ID'].name].prefix;
		var project="";
		//-------------------------------------
		$('#D__ID').on('load',function(){
			project=$vm.vm['__ID'].op.input.record;
			_set_req(); _request_data();
		})
		//-------------------------------------
		_cell_render=function(records,I,field,td,set_value,source){
            switch(field){
                case '_Call_Log':
                    records[I].vm_custom[field]=true;
                    td.html("<u style='cursor:pointer;'>Call Log...</u>");
                    td.find('u').on('click',function(){
						$vm.nav_load_module(prefix+'volunteer-call-log','',{record:records[I],Project_Name:project.Project_Name});
	                })
                    break;
                case '_Summary':
                        records[I].vm_custom[field]=true;
                        td.html("<u style='cursor:pointer;'>Summary...</u>");
						td.find('u').on('click',function(){
							$vm.nav_load_module(prefix+'volunteer-summary','',{record:records[I]});
		                })
                        break;
                case 'Status':
                            records[I].vm_custom[field]=true;
                            var html="<select style='border:0;'>"
                            if(records[I].Reserved=='Reserved'){
                                html+="<option>Registration</option>";
                                html+="<option>Screening Failure</option>";
                                html+="</select>"
                            }
                            else{
                                html+="<option>Registration</option>";
                                html+="<option>Screening</option>";
                                html+="<option>Screening Failure</option>";
                                html+="<option>Enrolled</option>";
                                html+="<option>Withdrawn</option>";
                                html+="<option>Completed</option>";
                                html+="</select>"
                            }
                            td.html(html)
                            td.find('select').val(records[I][field])
                            td.find('select').on('change', function(){
                                set_value($(this).val(),records,I,field);
                                var today = new Date();
                                var dd = today.getDate();
                                var mm = today.getMonth()+1; //January is 0!
                                var yyyy = today.getFullYear();
                                if(dd<10){dd='0'+dd;}
                                if(mm<10){mm='0'+mm;}
                                var today = dd+'/'+mm+'/'+yyyy;
                                if($(this).val()==='DO NOT CALL' || $(this).val()==='Screening'){
                                    set_value(today,records,I,'Start_date');
                                    _render(I);
                                }
                                if($(this).val()==='Completed' || $(this).val()==='Withdrawn'){
                                    set_value(today,records,I,'End_date');
                                    _render(I);
                                }
                            });
                            break;
					case 'Reserved':
                        if(records[I].Reserved=='Reserved'){
                            td.css('color','red');
                        }
                        td.attr('contenteditable','false')
                        td.find('div').attr('contenteditable','false')
                        break;
                    case 'Start_date':
                    case 'End_date':
	                    if(records[I].Reserved=='Reserved'){
	                        td.css('color','red');
	                        td.attr('contenteditable','false')
	                        td.find('div').attr('contenteditable','false')
	                    }
	                    else{
	                        VmInclude:__COMPONENT__/grid/field_date.js
	                    }
                        break;
					case 'First_Name':
					case 'Last_Name':
						records[I].vm_readonly[field]=true;
						break;
					case 'Medical_Research':
					case 'Asthma':
					case 'COPD':
					case 'Emphysema':
					case 'Lung_Cancer':
						td.html('<input type=checkbox />');
						VmInclude:__COMPONENT__/grid/field_checkbox.js
						td.find('input').off('click').on('click', function(){return false;})
						break;
            }
        }
		//-------------------------------------
		//B1=1 	Medical_Research;
		//20008533: registration
		//20009716: project
		//20011360: volunteer status
		//@S2: project name
		var sql_0="with current_project as (select P_V1=convert(int,V1),P_V2=convert(int,V2) from [TABLE-20009716] where S3=@S2 )";
		sql_0+=",registration as (select UID,Information,R_V1=convert(int,V1),B1 from [TABLE-20008533] /*where B1=1*/ )";
		sql_0+=",busy_flag as (select bID=ID,bFlag=S1,PUID from [TABLE-20011361])";
		sql_0+=",status as (select ID,PUID,Status=S1 from [TABLE-20011360] where S3=@S2)";
		sql_0+=",volunteer as (select ID,bID,bFlag,Status,UID,Information,R_V1,RowNum=row_number() over (order by UID DESC) from registration ";
		sql_0+="left join busy_flag on UID=busy_flag.PUID ";
		sql_0+="left join status    on UID=status.PUID ";
		sql_0+="join current_project on R_V1&P_V1=P_V1 or Status='Registration' ";
		sql_0+="where bFlag=@S2 or bFlag is NULL )";
		sql_0+=",all_results as (select * from volunteer)";
		//-------------------------------------
		_set_req=function(){
			var sql  =sql_0+" select * from all_results where RowNum between @I6 and @I7"
			var sql_n=sql_0+" select count(UID) from all_results";
			_req={cmd:'query_records',db_pid:_db_pid,sql:sql,sql_n:sql_n,s1:'"'+$('#keyword__ID').val()+'"',I:$('#I__ID').text(),page_size:$('#page_size__ID').val(),s2:project.Project_Name}
		}
		//-------------------------------------
		_set_req_export=function(i1,i2){
			var sql  =sql_0+" select * from all_results where RowNum between @I1 and @I2"
			_req={cmd:'query_records',sql:sql,i1:i1,i2:i2,s2:project.Project_Name};
		}
		//-----------------------------------------------
		_before_submit=function(record,dbv){
			dbv.S1=record.Status;
			dbv.S2=record.First_Name+' '+record.Last_Name;
			dbv.S3=project.Project_Name;
			dbv.PUID=record.volunteer_UID;
			dbv.GUID=record.Project_UID;
            return true;
        };
        //-------------------------------------
		_after_submit=function(I,res,type,dbv){
			//BI processing. first second caculate busy state, second get busy record's ID,
			jQuery.ajaxSetup({async:false});
			var busy="";
			//get all project status of this voulunteer
			var sqlA="select S1,S3 from [TABLE-20011360] where PUID=@I1";
			var reqA={cmd:'query_records',sql:sqlA,i1:_records[I].UID,s2:project.Project_Name};
			$VmAPI.request({data:reqA,callback:function(res){
				for(var i=0;i<res.records.length;i++){
					if(res.records[i].S1!="Completed" && res.records[i].S1!="Registration"){
						busy=res.records[i].S3;
						break;
					}
				}
				//get busy record ID of this volunteer
				var sqlB="select ID from [TABLE-20011361] where PUID=@I1";
				var reqB={cmd:'query_records',sql:sqlB,i1:_records[I].UID};
				$VmAPI.request({data:reqB,callback:function(res){
					var reqC="";
					if(res.records.length!=0){
						var rid=res.records[0].ID;
						reqC={cmd:"add_modify",rid:rid.toString(),data:{},dbv:{S1:busy,PUID:_records[I].UID}};
					}
					else{
						reqC={cmd:"add_record",db_pid:"20011361",data:{},dbv:{S1:busy,PUID:_records[I].UID}};
					}
					$VmAPI.request({data:reqC,callback:function(res){}})
				}})
			}});
			jQuery.ajaxSetup({async:true});
        };
        //-------------------------------------
    }
</script>
<style>
    VmInclude:__COMPONENT__/grid/grid.v3.css
</style>
